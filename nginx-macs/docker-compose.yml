# docker-compose.yml
# Local dev setup: nginx reverse-proxy + simple backend replicas that fetch the GitHub Pages URL
# Usage:
#   docker compose up --build --scale backend=3 -d
#
version: "3.8"

services:
  backend:
    image: python:3.11-slim
    container_name: protectai-backend
    restart: unless-stopped
    networks:
      - web
    environment:
      - FETCH_URL=https://protectai.github.io/llm-guard/api/overview/
      - FETCH_INTERVAL=30
    command: >
      /bin/sh -c "apt-get update -y >/dev/null 2>&1 && apt-get install -y --no-install-recommends curl >/dev/null 2>&1 || true;
      mkdir -p /usr/src/app;
      # initial fetch
      curl -fsSL \"$${FETCH_URL}\" -o /usr/src/app/index.html || true;
      # keep fetching in the background so content is refreshed periodically
      while true; do
        sleep $${FETCH_INTERVAL};
        curl -fsSL \"$${FETCH_URL}\" -o /usr/src/app/index.html || true;
      done & 
      python3 -m http.server 8080 --directory /usr/src/app --bind 0.0.0.0"
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-S", "-q", "http://localhost:8080/"] 
      interval: 30s
      timeout: 5s
      retries: 3

  nginx-proxy:
    image: nginx:1.29-perl
    container_name: protectai-nginx
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - nginx-certs:/etc/ssl/private
    command: >
      /bin/sh -c '
        apk add --no-cache openssl >/dev/null 2>&1 || true;
        mkdir -p /etc/ssl/private /etc/nginx/conf.d;
        # generate a local self-signed certificate if none exists
        if [ ! -f /etc/ssl/private/selfsigned.key ] || [ ! -f /etc/ssl/private/selfsigned.crt ]; then
          openssl req -x509 -nodes -newkey rsa:2048 -days 3650 \
            -subj "/C=US/ST=State/L=City/O=Local/CN=localhost" \
            -keyout /etc/ssl/private/selfsigned.key \
            -out /etc/ssl/private/selfsigned.crt;
        fi;
        # write a minimal nginx configuration that load-balances to the 'backend' service
        cat > /etc/nginx/conf.d/default.conf <<'NGX_EOF'
        # Nginx reverse proxy + basic load balancing for backends
        resolver 127.0.0.11 valid=10s ipv6=off;

        upstream backend_pool {
            least_conn;
            server backend:8080;
        }

        server {
            listen 80;
            server_name localhost;

            # Redirect HTTP to HTTPS
            location / {
                return 301 https://$host$request_uri;
            }
        }

        server {
            listen 443 ssl;
            server_name localhost;

            ssl_certificate /etc/ssl/private/selfsigned.crt;
            ssl_certificate_key /etc/ssl/private/selfsigned.key;
            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_prefer_server_ciphers on;

            # Proxy specifically the GitHub Pages path (keeps backend serving root)
            location ^~ /llm-guard/api/overview/ {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                # strip the /llm-guard/api/overview/ prefix so backend serves its root index
                proxy_pass http://backend_pool/;
                proxy_read_timeout 120s;
            }

            # Fallback: proxy everything else to backend root (useful for assets)
            location / {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_pass http://backend_pool;
                proxy_read_timeout 120s;
            }
        }
        NGX_EOF

        nginx -g "daemon off;"
      '
    healthcheck:
      test: ["CMD", "wget", "--spider", "-S", "-q", "https://localhost/llm-guard/api/overview/"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  web:
    driver: bridge

volumes:
  nginx-certs: